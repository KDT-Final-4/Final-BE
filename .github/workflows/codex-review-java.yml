name: Codex Code Review (Python & Java)

on:
  pull_request_target:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  codex-review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ github.token }}

    steps:
      # âœ… ë°˜ë“œì‹œ base ë¸Œëžœì¹˜ë§Œ checkout (í¬í¬ ì½”ë“œ ì‹¤í–‰ ê¸ˆì§€)
      - name: Checkout base branch (safe)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0

      - name: Get list of changed files
        id: changed-files
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed_files.txt || true
          cat changed_files.txt || true

          FILES=$(paste -sd, changed_files.txt || true)
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      - name: Validate OpenAI API Key
        run: |
          set -euo pipefail

          if [ -z "${OPENAI_API_KEY:-}" ]; then
            echo "âŒ FATAL ERROR: OPENAI_API_KEY is not set"
            exit 1
          fi

          echo "âœ… OPENAI_API_KEY is set (masked)"

      - name: Build Codex prompt from diff
        run: |
          set -euo pipefail

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          DIFF_LINES=$(git --no-pager diff --unified=5 "$BASE_SHA" "$HEAD_SHA" | wc -l)
          echo "ðŸ“Š Diff size: $DIFF_LINES lines"

          cat > codex-prompt.md << 'EOF'
          ë‹¹ì‹ ì€ Python ë° Java ë°±ì—”ë“œë¥¼ ë‹´ë‹¹í•˜ëŠ” ì‹œë‹ˆì–´ í’€ìŠ¤íƒ ê°œë°œìžìž…ë‹ˆë‹¤.
          ...
          EOF

          echo "" >> codex-prompt.md
          echo "=== DIFF START ===" >> codex-prompt.md
          git --no-pager diff --unified=5 "$BASE_SHA" "$HEAD_SHA" >> codex-prompt.md

      - name: Run Codex review
        id: run-codex
        uses: openai/codex-action@main
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt-file: codex-prompt.md
          model: gpt-4o-mini
          output-file: codex-output.json
          sandbox: read-only
        continue-on-error: true
