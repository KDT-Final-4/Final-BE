name: Codex Code Review (Java)

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

jobs:
  codex-review:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout pull request merge commit
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.pull_request.number }}/merge

      - name: Get list of changed files
        id: changed-files
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          git diff --name-only "$BASE_SHA" "$HEAD_SHA" > changed_files.txt
          echo "Changed files:"
          cat changed_files.txt || true

          FILES=$(paste -sd, changed_files.txt || true)
          echo "files=$FILES" >> "$GITHUB_OUTPUT"

      - name: Build Codex prompt from diff (Java backend)
        run: |
          set -euo pipefail
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          cat > codex-prompt.md << 'EOF'
          당신은 Java 기반 백엔드(스프링/마이바티스/Oracle)를 담당하는 시니어 서버 개발자입니다.
          아래 Pull Request의 변경 사항에 대해 코드 리뷰를 수행하십시오.

          요구사항:
          - 반드시 한국어로, 존댓말(하십시오체)로 답변하십시오.
          - 리뷰 결과는 JSON 배열로만 작성하십시오. 다른 텍스트는 포함하지 마십시오.
          - 각 항목은 다음 필드를 포함해야 합니다:
            - "file": "변경된 파일의 상대 경로"
            - "line": 해당 이슈를 대표하는 코드의 1-based line 번호
            - "severity": "Critical", "Major", "Minor" 중 하나
            - "title": 이슈를 한 문장으로 요약한 한국어 제목
            - "body": 문제 설명과 개선 제안을 담은 한국어 본문. 반드시 존댓말(하십시오체)을 사용하십시오.

          심각도 기준:
          - Critical: 치명적인 버그, 데이터 무결성 훼손, 보안 취약점, 장애 가능성이 큰 로직 등 반드시 수정해야 하는 이슈
          - Major: 잠재적으로 장애나 버그로 이어질 수 있는 설계/구현 문제, 심각한 성능 문제, 잘못된 예외 처리 등
          - Minor: 가독성, 네이밍, 주석, 스타일, 리팩터링 제안 등 사소한 개선 사항

          이 저장소는 다음과 같은 역할을 합니다:
          - Java 기반 백엔드 애플리케이션
          - MyBatis를 통한 Oracle DB 연동
          - 비즈니스 로직, 트랜잭션 처리, SQL 매퍼, DTO/VO, 서비스/레포지토리 계층 등

          리뷰 시 특히 다음을 주의 깊게 봐 주십시오:
          - 트랜잭션 경계 설정이 적절한지
          - MyBatis 매퍼에서 N+1, 불필요한 풀스캔, 잘못된 조인 등이 없는지
          - Null 처리, 예외 처리, 로깅이 적절한지
          - DTO/엔티티 변환이 일관적인지
          - 향후 유지보수에 지장을 줄 만한 하드코딩/매직넘버가 없는지

          아래에는 이번 Pull Request의 diff가 포함됩니다.
          이 diff에서 보이는 부분에 대해서만 리뷰를 작성하십시오.

          최종 출력은 반드시 위에서 정의한 JSON 배열 형식만 사용하십시오.
          EOF

          echo "" >> codex-prompt.md
          echo "=== DIFF START ===" >> codex-prompt.md
          git --no-pager diff --unified=5 "$BASE_SHA" "$HEAD_SHA" >> codex-prompt.md

      - name: Run Codex review
        id: run-codex
        uses: openai/codex-action@main
        with:
          openai-api-key: ${{ env.OPENAI_API_KEY }}
          prompt-file: codex-prompt.md
          model: o4-mini
          output-file: codex-output.json
          sandbox: read-only

      - name: Parse Codex output into GitHub comments
        id: parse-codex
        run: |
          set -euo pipefail

          if [ ! -s codex-output.json ]; then
            echo "Codex output is empty. Nothing to comment."
            echo "has_comments=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Codex raw output:"
          cat codex-output.json
          echo ""

          NORMALIZED=$(cat codex-output.json | jq 'try (fromjson) catch .')
          echo "$NORMALIZED" > codex-output.json

          if [ "$(jq 'length' codex-output.json)" -eq 0 ]; then
            echo "No review comments from Codex."
            echo "has_comments=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Parsed Codex comments:"
          cat codex-output.json

          echo "has_comments=true" >> "$GITHUB_OUTPUT"

      - name: Post inline review comments to PR
        if: steps.parse-codex.outputs.has_comments == 'true'
        run: |
          set -euo pipefail

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          COMMIT_SHA=${{ github.event.pull_request.head.sha }}

          length=$(jq 'length' codex-output.json)
          echo "Posting $length review comments from Codex..."

          for i in $(seq 0 $((length - 1))); do
            file=$(jq -r ".[$i].file" codex-output.json)
            line=$(jq -r ".[$i].line" codex-output.json)
            severity=$(jq -r ".[$i].severity" codex-output.json)
            title=$(jq -r ".[$i].title" codex-output.json)
            body=$(jq -r ".[$i].body" codex-output.json)

            comment="[$severity] $title

$body"

            echo "Comment on $file:$line"
            echo "$comment"
            echo "----"

            jq -n               --arg body "$comment"               --arg path "$file"               --argjson line "$line"               --arg sha "$COMMIT_SHA"               '{
                body: $body,
                path: $path,
                line: $line,
                side: "RIGHT",
                commit_id: $sha
              }' > comment.json

            curl -sS               -X POST               -H "Accept: application/vnd.github+json"               -H "Authorization: Bearer '"'"'${GITHUB_TOKEN}'"'"'               -H "X-GitHub-Api-Version: 2022-11-28"               "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/comments"               -d @comment.json

      - name: Post summary comment
        if: steps.parse-codex.outputs.has_comments == 'true'
        run: |
          set -euo pipefail

          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}

          SUMMARY="**Codex 자동 코드 리뷰 요약**

Codex가 PR에 대한 자동 코드 리뷰를 생성하였습니다.
세부 내용은 inline 코멘트를 참고해 주십시오."

          jq -n --arg body "$SUMMARY" '{ body: $body }' > summary.json

          curl -sS             -X POST             -H "Accept: application/vnd.github+json"             -H "Authorization: Bearer '"'"'${GITHUB_TOKEN}'"'"'             -H "X-GitHub-Api-Version: 2022-11-28"             "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"             -d @summary.json
