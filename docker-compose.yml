version: "3.9"

services:
  oracle:
    image: gvenzl/oracle-free:23.5-slim
    environment:
      TZ: Asia/Seoul
      ORACLE_PASSWORD: ${ORACLE_PASSWORD}
      APP_USER: ${APP_USER}
      APP_USER_PASSWORD: ${APP_USER_PASSWORD}
    ports:
      - "15210:1521"
    volumes:
      - ${ORACLE_DATA_VOLUME:-oracle-data}:/opt/oracle/oradata
    healthcheck:
      test: ["CMD", "bash", "-c", "echo 'SELECT 1 FROM dual;' | sqlplus -s ${APP_USER}/${APP_USER_PASSWORD}@localhost/FREE"]
      interval: 20s
      timeout: 10s
      retries: 10
      start_period: 60s

  app:
    image: gradle:8.10.2-jdk21
    depends_on:
      oracle:
        condition: service_healthy
    working_dir: /workspace
    command: ["./gradlew", "bootRun"]
    environment:
      SPRING_DATASOURCE_URL: ${SPRING_DATASOURCE_URL}
      SPRING_DATASOURCE_USERNAME: ${SPRING_DATASOURCE_USERNAME}
      SPRING_DATASOURCE_PASSWORD: ${SPRING_DATASOURCE_PASSWORD}
      SPRING_JPA_HIBERNATE_DDL_AUTO: ${SPRING_JPA_HIBERNATE_DDL_AUTO}
    ports:
      - "8080:8080"
    volumes:
      - ./:/workspace
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  oracle-data:
